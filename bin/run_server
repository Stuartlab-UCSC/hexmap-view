#!/bin/bash

# Point of entry for the run scripts. 

# Examples:
# run db        (action defaults to 'start')
# run start db
# run stop db
# run install <full-path-to-tar.gz-file>   (for installing on prod)
# run deploy

# Production run script that calls this script
# !/bin/bash
# ACTION=$1
# SERVER_TYPE=$2
# OPTION=$3
# CONFIG=prod
# HEXMAP=/data
# $HEXMAP/bin/run_server $ACTION $CONFIG $HEXMAP $SERVER_TYPE $OPTION

ACTION=$1       # The action on the server, one of:
                #   / start / stop / deploy / install /
                # or type of server for the short form of starting a server, one of:
                #   / www / db / http / https /
CONFIG=$2       # The configuration of the server, one of:
                #   / prod / dev / ... /
HEXMAP=$3       # Full path of this installation instance
SERVER_TYPE=$4  # Type of server, one of:
                #   / www / db / http / https /
                # or not required for the short form to start a server.

# An action must be specified.
if [ -z ${ACTION} ]; then
    echo You need to specify an ACTION to the run script, one of:
    echo     / start / stop / deploy / install /
    echo Exiting
    exit
fi

# A configuration must be specified.
if [ -z ${CONFIG} ]; then # if no config specified
    echo You need to set CONFIG in the run script.
    echo Exiting
    exit
fi

# A hexmap path must be specified.
if [ -z ${HEXMAP} ]; then
    echo You need to set HEXMAP in the run script.
    echo Exiting
    exit
fi

# Handle the short form of starting a server.
if [ $ACTION == 'www' ] || [ $ACTION == 'db' ] || [ $ACTION == 'http' ] || [ $ACTION == 'https' ]; then
    SERVER_TYPE=$ACTION
    ACTION=start
fi

export HEXMAP
BIN=$HEXMAP/bin

# If the action is for a server...
if [ $ACTION == 'start' ] || [ $ACTION == 'stop' ]; then

    # A server type must be specified.
    if [ $SERVER_TYPE != 'www' ] && [ $SERVER_TYPE != 'wwwViz' ] && [ $SERVER_TYPE != 'db' ] && [ $SERVER_TYPE != 'http' ] && [ $SERVER_TYPE != 'https' ]; then
        echo You need to specify a SERVER_TYPE to the run script, one of:
        echo     / www / db / http / https /
        echo Exiting
        exit
    elif [ $ACTION == 'start' ]; then
        $BIN/start_server.sh $CONFIG $HEXMAP $SERVER_TYPE
    else
        $BIN/stop_server.sh $HEXMAP $SERVER_TYPE
    fi

# Handle the deploy action.
elif [ $ACTION == 'deploy' ]; then

    # Don't allow deploy on production or dev.
    if [ $CONFIG == 'prod' ] || [ $CONFIG == 'dev' ]; then
        echo Sorry you cannot deploy from production or dev!
        echo Exiting
        exit
    fi
    $BIN/deploy_www.sh $HEXMAP

# Handle the install action.
elif [ $ACTION == 'install' ]; then

    # Don't allow install on anything other than production or dev.
    if [ $CONFIG != 'prod' ] && [ $CONFIG != 'dev' ]; then
        echo Sorry you cannot install to here and remove all of your current code!
        echo Exiting
        exit
    fi
    $BIN/install_www.sh $HEXMAP

else
    echo Invalid ACTION as a first parameter: $ACTION
    echo Exiting
fi

