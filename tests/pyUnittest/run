#!/bin/bash
# Run a test after setting the path

if [ $# -eq 0 ]; then
    echo "one argument is needed like this:"
    echo "  all tests: run all (all except for hub tests)"
    echo "  hub tests: run hub"
    echo "   one file: run test_stats"
    echo "   one test: run test_stats.TestStats.test_stats"
    exit 1
fi

# Set env vars specific to the installation
if [ $HEXMAP == '/data' ]; then
    # Production servers on tumormap
    export VIEWER_URL=https://tumormap.ucsc.edu
    export HUB_SOCKET=hexdev.sdsc.edu:8332
    export HUB_PATH=/hive/groups/hexmap/prod/hub
    export PYTHONPATH=/cluster/home/swat/dev/www/server:$HUB_PATH:./

elif [ $HEXMAP == '/cluster/home/swat/dev' ]; then
    # Development servers on hexdev
    export VIEWER_URL=https://hexdev.sdsc.edu:8222
    export HUB_SOCKET=hexdev.sdsc.edu:8332
    export HUB_PATH=/hive/groups/hexmap/prod/hub
    export PYTHONPATH=$HEXMAP/www/server:$HUB_PATH:./

elif [ $HEXMAP == '/Users/swat/dev/hexagram' ]; then
    # Development servers on swat's local
    export VIEWER_URL=http://localhost:3333
    export HUB_SOCKET=localhost
    export HUB_PATH=$(pwd)/../../hub
    export PYTHONPATH=$HEXMAP/www/server:$HUB_PATH:./

elif [ $HEXMAP == '/home/duncan/Desktop/TumorMap/TMdev/hexagram' ]; then
    # Development servers on swat's local
    export HUB_SOCKET=localhost
    export VIEWER_URL=http://localhost:3333
    export HUB_PATH=$(pwd)/../../hub
    export PYTHONPATH=$HEXMAP/www/server:$HUB_PATH:./
fi

# Set env vars common to all installations
export HUB_TESTING=false
export HUB_DEBUG=true

# Note: the below are currently order-dependent due to issues with parallel code
ALL=( \
    test_layoutBasic \
    test_stats \
    placeNode_calc_tests \
    test_similarity \
)
PARALLEL_CHALLENGED=( \
    test_dynLayoutAware \
    test_sim6Layout \
)
HUB=( \
    hub_web_tests \
    placeNode_web_tests \
)

# these need fixing up:
    #test_createMapUi \
    #test_http \
    #test_noincludesingletons \
    #test_queryOverlayNodes \
    #test_remoteCalc \

TO_RUN=($1)
if [ $1 == 'all' ]
    then TO_RUN="${ALL[@]}"
elif [ $1 == 'hub' ]
    then TO_RUN="${HUB[@]}"

fi

# Run our well-behaved tests in parallel
python2.7 -m unittest $TO_RUN

# Run our parallel-challenged tests independently
if [ $1 == 'all' ]
    then
    echo Running parallel-challenged tests independently
    for TEST in "${PARALLEL_CHALLENGED[@]}"
    do
        python2.7 $TEST.py
    done
fi
